# Проект на FastAPI з підтримкою системи Трембіта

## Опис
Цей проєкт входить в набір прикладів взаємодії з API шлюзу безпечного обміну системи Трембіта (ШБО), що демонструють технічні особливості розробки вебсервісів та вебклієнтів, сумісних з системою Трембіта. Даний проєкт представляє опис створення сумісного REST-сервісу на мові програмування Python з використанням фреймворку FastAPI. FastAPI - це сучасний, швидкий (високопродуктивний) web-фреймворк для побудови API з Python 3.10+ на основі стандартних асинхронних викликів. Проєкт підтримує систему Трембіта (логування заголовків).\
Приклад описує отримання з умовної бази даних (реєстру) відомостей про інформаційні об'єкти (у прикладі об'єктом є користувач) та управління їх статусом, у тому числі обробку запитів на пошук, отримання, створення, редагування та видалення об'єктів через REST API, що доступне через систему Трембіта.


## Вимоги до програмного забезпечення 
| ПЗ            |   Версія   | Примітка                                                                                                                                                                                               |
|:--------------|:----------:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Ubuntu Server |   24.04    | Рекомендовані характеристики віртуальної машини:<br/> CPU: 1 <br/> RAM: 512 Мб                                                                                                                         |
| Python        | **3.10!**  | За допомогою скрипта встановлюється автоматично.<br/> Також можна встановити вручну при виборі відповідного типу інсталяції.<br/>**Важливо!** Якщо версія Python нижче 3.10, сервіс працювати не буде. |
| MariaDB       |   10.5+    | За допомогою скрипта встановлюється автоматично.<br/> Також можна встановити вручну при виборі відповідного типу інсталяції                                                                            |
| Git           |            | Для клонування репозиторію                                                                                                                                                                             |


## Залежності
Залежності зазначені в файлі requirements.txt.

## Структура проєкту

Структура проєкту виглядає наступним чином:

```
FastAPI_trembita_service/
├── main.py                # Точка входу застосунку
├── config.ini             # Конфігурація проєкту
├── alembic.ini            # Конфігурація міграцій БД
├── utils/
│   ├── validations.py     # Валідація параметрів
│   ├── update_person.py   # Оновлення запису у БД
│   ├── get_person.py      # Пошук запису у БД за критерієм
│   ├── get_all_persons.py # Отримання всіх записів БД
│   ├── delete_person.py   # Видалення запису з БД
│   ├── create_person.py   # Створення запису у БД
│   └── config_utils.py    # Зчитування конфігураційного файлу
├── models/
│   └── person.py          # Моделі даних
├── migrations/
│   └── env.py             # Підключення моделей для Alembic
├── docs/                  # Документація з розгортання
├── requirements.txt       # Залежності проєкту
├── README.md              # Документація
├── deploy.sh              # Скрипт для автоматизації встановлення
├── remove.sh              # Скрипт для видалення сервісу та очищення системи
```

## Інсталяція сервісу

Сервіс можна інсталювати за допомогою скрипта автоматичного встановлення або вручну. Також сервіс може працювати в Docker 
- [Інсталяція сервісу за допомогою скрипта автоматичного встановлення](./docs/script_installation.md).
- [Інсталяція сервісу вручну](./docs/manual_installation.md).
- [Конфігурація сервісу](./docs/manual_installation.md). исправить ссілку
- [Pозгортання вебсервісу в Docker ](./docs/docker_installation.md).


## Наповнення бази даних тестовими записами
Для забезпечення зручності тестування розробленого вебсервісу потрібно наповнити його БД тестовими записами.
З цією метою було розроблено окремий скрипт, інсталяція та робота з яким описані тут

## Адміністрування сервісу

### Запуск вебсервісу
Після того, як вебсервіс було встановлено, його необхідно запустити за допомогою команди:
   ```bash
   sudo systemctl start fastapi_trembita_service
   ```
### Ознайомлення з документацією АРІ
Після запуску вебсервісу можна отримати доступ до автоматичної **документації API** за наступними адресами:
**Swagger UI**: http://[адреса серверу]:8000/docs
**ReDoc**: http://[адреса серверу]:8000/redoc

### Перевірка статусу вебсервісу
   ```bash
   sudo systemctl status fastapi_trembita_service
   ```
### Зупинка вебсервісу
   ```bash
   sudo systemctl stop fastapi_trembita_service
   ```
### Видалення вебсервісу.
Для видалення вебсервісу та всіх пов'язаних компонентів було створено скрипт `remove.sh`.
Даний скрипт після запуску, зупинить та видалить вебсервіс, видалить віртуальне середовище, клонований репозиторій та системні залежності.
Для того, щоб запустити скрипт необхідно:
1. Зробити файл виконуваним:

   ```bash
   chmod +x remove.sh
   ```

2. Запустити скрипт:

   ```bash
   ./remove.sh
   ```
### Перегляд журналу подій
За замовчуванням журнал подій зберігається у файлі `file.log`
Конфігурація параметрів журналювання подій виконується в файлі «config.ini». Детальніше з параметрами журналювання в даному файлі можна ознайомитися в розділі 2.3.
Для того, щоб переглянути журнал подій необхідно виконати команду:
   ```bash
   journalctl -u fastapi_trembita_service -f
   ```
### Налаштування HTTPS
Налаштування підключення до сервісу за протоколом HTTPS наведено [в інструкції](./docs/https_nginx_reverse_proxy.md).

## Використання сервісу
### **Person Get All**

Повертає всі записи з БД.

|   Метод HTTP   | Код сервісу | Базова URL                                                                                                                                                                                              |
|:------------:|:-----------:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|      GET       |   Person Get All  | http://your-server-ip:8000/person                                                                                                                         |

**Параметри запиту**, що передаються в URL-строці виглядають наступним чином:

	"queryId":"?",
	"userId":"?"

де:

|  **Назва параметру**  |  **Тип даних**  |   **Значення параметру**   |  **Обов’язковість**  |
|:---------------------:|:---------------:|:--------------------------:|:--------------------:|
|        queryId        |     	String     |  	Ідентифікатор запиту     |         	Ні          |
|        userId         |     String      | 	Ідентифікатор користувача |         	Ні          |

Приклад запиту:
```
http://your-server-ip:8000/person?queryId=jsdjd532khshs&userId=MyGreatApplication
```
або:
```
http://your-server-ip:8000/person
```
Тіло відповіді у разі успішного опрацювання запиту (Code=200) виглядатиме наступним чином:
```
{
  "message": [
    {
      "id": 1,
      "name": "Марина",
      "surname": "Петренко",
      "patronym": "Петрівна",
      "dateOfBirth": "2078-10-28",
      "gender": "female",
      "rnokpp": "1111111111",
      "passportNumber": "123456789",
      "unzr": "20241011-12345"
    },
    {
      "id": 2,
      "name": "Карен",
      "surname": "Симоненко",
      "patronym": "Олегович",
      "dateOfBirth": "2067-12-22",
      "gender": "male",
      "rnokpp": "1111111131",
      "passportNumber": "133456789",
      "unzr": "20241011-12445"
    }
  ]
}

```
де:

|  Рівень <br/> вкладеності  | Назва <br/>параметру | Тип даних                         | Значення параметру                                                                                                                        | Обов’язковість |
|:--------------------------:|----------------------|-----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|:--------------:|
|             1              | 	message             | 	Array                            | 	Масив даних                                                                                                                              |      	Так      |
|             2              | 	id	                 | Integer                           | 	Ідентифікатор користувача                                                                                                                |      	Так      |
|             2              | 	name                | 	String, <br/>min=1, <br/>max=128 | 	Ім’я                                                                                                                                     |      	Так      |
|             2              | 	surname             | 	String, <br/>min=1, <br/>max=128 | 	Прізвище                                                                                                                                 |      	Так      |
|             2              | 	patronym            | 	String, <br/>min=0,<br/> max=128 | 	По батькові                                                                                                                              |      	Ні       |
|             2              | 	dateOfBirth         | 	String                           | 	Дата народження                                                                                                                          |      	Так      |
|             2              | 	gender              | 	String                           | 	Стать                                                                                                                                    |      	Так      |
|             2              | 	rnokpp              | 	String                           | 	РНОКПП, 10 цифр                                                                                                                          |      	Так      |
|             2              | 	passportNumber      | 	String                           | 	Номер паспорта.<br/> **Для старого формату** – перші 2 символи - літери від А до Я, пробіл, 6 цифр.<br/> **Для нового формату** – 9 цифр |      	Так      |
|             2              | 	unzr                | 	String                           | 	УНЗР, 14 символів в форматі YYYYMMDD-XXXXC, де  YYYY – рік, MM – місяць, DD – день,  XXXXC – 5 цифр                                      |      Так       |

Тіло відповіді у разі не успішного опрацювання запиту (**Code=404**) виглядатиме наступним чином:
```
{
"detail":"Person not found"
}
```
де:

| Рівень <br/> вкладеності | Назва <br/>параметру | Тип даних | Значення параметру | Обов’язковість |
|:------------------------:|----------------------|-----------|--------------------|:--------------:|
|            1             | 	detail              | 	String   | 	Опис помилки      |      	Так      |











## Внесок

Якщо ви хочете зробити свій внесок у проєкт, будь ласка, створіть форк репозиторію і відправте Pull Request.

## Ліцензія

Цей проєкт ліцензується відповідно до умов MIT License.
