# Розгортання вебсрвісу в Docker


## Зміст

1. [Вимоги](#вимоги)
2. [Змінні оточення](#змінні-оточення)
3. [Як зібрати Docker-образ](#як-зібрати-docker-образ)
4. [Як запустити контейнер](#як-запустити-контейнер)
5. [Перегляд логів](#перегляд-логів)
6. [Використання змінних оточення для конфігурації](#використання-змінних-оточення-для-конфігурації)
7. [Використання конфігураційного файлу](#використання-конфігураційного-файлу)

## Вимоги

| ПЗ             |   Версія   | Примітка                     |
|:---------------|:----------:|------------------------------|
| MariaDB        | **10.5+**  |                              |
| Docker         | **20.10+** |                              |
| Docker Compose |   10.5+    | Якщо планується використання |

## Змінні оточення

Вебсервіс підтримує конфігурацію через змінні оточення. 

Нижче наведено основні параметри:

- `USE_ENV_CONFIG`: Керує використанням змінних оточення для конфігурації. Якщо встановлено в `true`, додаток використовує змінні оточення замість конфігураційного файлу.
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль для підключення до бази даних.
- `DB_HOST`: Адреса хоста бази даних.
- `DB_NAME`: Ім'я бази даних.
- `LOG_FILENAME`: Ім'я файлу для логування. Якщо передано порожнє значення, логи будуть виводитися в консоль (stdout).
- `LOG_LEVEL`: Рівень логування (наприклад, `info`, `debug`).
- `LOG_FILEMODE`: Режим роботи з логами (наприклад, `a` — додавання до існуючого файлу або `w` — перезапис).

## Збір Docker-образу

Для того, щоб зібрати Docker-образ, необхідно:
1. Клонувати репозиторій:
```bash
git clone https://github.com/kshypachov/FastAPI_trembita_service.git
```
2. Перейти до директорії з вебсервісом:
```bash
cd FastAPI_trembita_service
```
3. Виконати наступну команду в кореневій директорії проєкту:
```bash
sudo docker build -t my-fastapi-app .
```

Дана команда створить Docker-образ з іменем «my-fastapi-app», використовуючи Dockerfile, який знаходиться в поточній директорії.

## Запуск та використання контейнера зі змінними оточення

Щоб запустити контейнер з вебсервісом, необхідно виконати наступну команду:

```bash
docker run -it --rm -p 8000:8000 \
    -e USE_ENV_CONFIG=true \
    -e DB_USER=myuser \
    -e DB_PASSWORD=mypassword \
    -e DB_HOST=mydbhost \
    -e DB_NAME=mydatabase \
    -e LOG_LEVEL=info \
    -e LOG_FILENAME="" \
    my-fastapi-app
```
де:
- Прапор `-p 8000:8000` перенаправляє порт 8000 на локальній машині на порт 8000 всередині контейнера.
- `DB_USER`: Ім'я користувача бази даних.
- `DB_PASSWORD`: Пароль для підключення до бази даних.
- `DB_HOST`: Адреса хоста бази даних.
- `DB_NAME`: Назва бази даних.
- Змінна `LOG_FILENAME=""` задає виведення логів у консоль (stdout).

Якщо ви плануєте повністю покладатися на змінні оточення для конфігурації, переконайтеся, що `USE_ENV_CONFIG=true`. 

Наприклад:
```bash
docker run -it --rm -p 8000:8000 \
    -e USE_ENV_CONFIG=true \
    -e DB_USER=myuser \
    -e DB_PASSWORD=mypassword \
    -e DB_HOST=mydbhost \
    -e DB_NAME=mydatabase \
    -e LOG_LEVEL=debug \
    my-fastapi-app
```

## Запуск та використання контейнера з конфігураційним файлом

Контейнер з вебсервісом можна запустити використовуючи конфігураційний файл замість змінних оточення. 
Для цього необхідно додати файл `config.ini` в директорію додатка та вказати шлях до нього:

```bash
docker run -it --rm -p 8000:8000 \
    -v $(pwd)/config.ini:/app/config.ini \
    my-fastapi-app
```

де прапор `-v $(pwd)/config.ini:/app/config.ini` монтує локальний файл конфігурації в контейнер за шляхом `/app/config.ini`.

 **Приклад конфігураційного файлу `config.ini`:**

```ini
[database]
db_type = mysql
username = myuser
password = mypassword
host = mydbhost
name = mydatabase

[logging]
filename = /var/log/app.log
filemode = a
format = %(asctime)s - %(name)s - %(levelname)s - %(message)s
dateformat = %Y-%m-%d %H:%M:%S
level = info
```

Якщо змінна оточення «USE_ENV_CONFIG» не задана або встановлена в false, додаток буде використовувати конфігураційний файл для налаштування. Необхідно переконатись, що файл доступний у контейнері, як показано в даному розділі вище.

## Перегляд логів

Якщо виведення журналів подій налаштоване у консоль, переглядати їх можна за допомогою команди:

```bash
docker logs <container_id>
```

В разі, якщо журнали подій зберігаються у файл (через змінну оточення LOG_FILENAME або конфігураційний файл), можна налаштувати монтування директорії з журналами подій на локальній машині наступним чином:

```bash
docker run -it --rm -p 8000:8000 \
    -e LOG_FILENAME="/var/log/app.log" \
    -v $(pwd)/logs:/var/log \
    my-fastapi-app
```

Тут `-v $(pwd)/logs:/var/log` монтує локальну директорію для збереження логів.

